#include "gui.h"
#include "hello_template.h"
#include <QApplication>
#include <QMainWindow>
#include <cassert>
#include <ceres/ceres.h>
#include <chrono>
#include <cmath>
#include <glog/logging.h>
#include <iomanip>
#include <iostream>
#include <qcustomplot.h>
#include <thread>
using ceres::AutoDiffCostFunction;
using ceres::CostFunction;
using ceres::Problem;
using ceres::Solve;
using ceres::Solver;
int main(int argc, char **argv) {
  google::InitGoogleLogging(argv[0]);
  QApplication app(argc, argv);
  MainWindow w;
  auto x0 = (1.0);
  auto x1 = (1.0);
  auto x2 = (1.0);
  auto x3 = (1.0);
  auto x4 = (1.0);
  auto problem = Problem();
  auto n = 67;
  auto data_x = std::vector<double>({(0.),
                                     (7.575757575758e-2),
                                     (0.151515151515151520000000000000),
                                     (0.227272727272727300000000000000),
                                     (0.303030303030303040000000000000),
                                     (0.378787878787878800000000000000),
                                     (0.454545454545454600000000000000),
                                     (0.530303030303030300000000000000),
                                     (0.606060606060606100000000000000),
                                     (0.681818181818181800000000000000),
                                     (0.757575757575757600000000000000),
                                     (0.833333333333333300000000000000),
                                     (0.909090909090909200000000000000),
                                     (0.984848484848484900000000000000),
                                     (1.06060606060606060000000000000),
                                     (1.13636363636363620000000000000),
                                     (1.21212121212121220000000000000),
                                     (1.28787878787878780000000000000),
                                     (1.36363636363636350000000000000),
                                     (1.43939393939393940000000000000),
                                     (1.51515151515151510000000000000),
                                     (1.59090909090909080000000000000),
                                     (1.66666666666666650000000000000),
                                     (1.74242424242424270000000000000),
                                     (1.81818181818181830000000000000),
                                     (1.89393939393939400000000000000),
                                     (1.96969696969696970000000000000),
                                     (2.04545454545454540000000000000),
                                     (2.12121212121212100000000000000),
                                     (2.19696969696969700000000000000),
                                     (2.27272727272727250000000000000),
                                     (2.34848484848484860000000000000),
                                     (2.42424242424242430000000000000),
                                     (2.50),
                                     (2.57575757575757570000000000000),
                                     (2.65151515151515140000000000000),
                                     (2.72727272727272700000000000000),
                                     (2.80303030303030280000000000000),
                                     (2.87878787878787900000000000000),
                                     (2.95454545454545460000000000000),
                                     (3.03030303030303030000000000000),
                                     (3.10606060606060600000000000000),
                                     (3.18181818181818170000000000000),
                                     (3.25757575757575730000000000000),
                                     (3.33333333333333300000000000000),
                                     (3.40909090909090870000000000000),
                                     (3.48484848484848530000000000000),
                                     (3.56060606060606060000000000000),
                                     (3.63636363636363670000000000000),
                                     (3.71212121212121200000000000000),
                                     (3.78787878787878800000000000000),
                                     (3.86363636363636330000000000000),
                                     (3.93939393939393940000000000000),
                                     (4.01515151515151500000000000000),
                                     (4.09090909090909100000000000000),
                                     (4.16666666666666700000000000000),
                                     (4.24242424242424200000000000000),
                                     (4.31818181818181800000000000000),
                                     (4.39393939393939400000000000000),
                                     (4.46969696969697000000000000000),
                                     (4.54545454545454500000000000000),
                                     (4.62121212121212100000000000000),
                                     (4.69696969696969700000000000000),
                                     (4.77272727272727300000000000000),
                                     (4.84848484848484900000000000000),
                                     (4.92424242424242400000000000000),
                                     (5.0)});
  auto data_y = std::vector<double>(
      {(1.06949962538833490000000000000), (1.06540341685377360000000000000),
       (1.06419656649951190000000000000), (1.21793175834297500000000000000),
       (1.15594847883848700000000000000), (1.27434061722068170000000000000),
       (1.30163348583459220000000000000), (1.36752580499767000000000000000),
       (1.34304919844247730000000000000), (1.31263553143176660000000000000),
       (1.33042045997159160000000000000), (1.49131910248425510000000000000),
       (1.40626597225279640000000000000), (1.40416730463658080000000000000),
       (1.49853520484142270000000000000), (1.55696324339820720000000000000),
       (1.56620529756914670000000000000), (1.67166334704065970000000000000),
       (1.58053174716000360000000000000), (1.69088090255526700000000000000),
       (1.80334423890091730000000000000), (1.83059057786916020000000000000),
       (1.75364544293639300000000000000), (1.77637679610941320000000000000),
       (1.85761402442289600000000000000), (2.02548616212613200000000000000),
       (2.02350291002899630000000000000), (2.03947105458518300000000000000),
       (2.10389904449525120000000000000), (2.08607487500016200000000000000),
       (2.09107464107415450000000000000), (2.29068493273482730000000000000),
       (2.37851666849185460000000000000), (2.35637413741608940000000000000),
       (2.33036653735919600000000000000), (2.37699120842927150000000000000),
       (2.45107455823655670000000000000), (2.48667560077877650000000000000),
       (2.63315459477403070000000000000), (2.64220589250481600000000000000),
       (2.73631114775378760000000000000), (2.72204271139461800000000000000),
       (2.89131901369014430000000000000), (2.99922634080496300000000000000),
       (3.03617076536438000000000000000), (3.16163875385164770000000000000),
       (3.21286354197757800000000000000), (3.13770175974876800000000000000),
       (3.30488567260809500000000000000), (3.31773230805070100000000000000),
       (3.34659836670090800000000000000), (3.44929265673882800000000000000),
       (3.62686162950686430000000000000), (3.68486784011758000000000000000),
       (3.80540992473394950000000000000), (3.91076748894120200000000000000),
       (3.97956074566825540000000000000), (4.05521517598004700000000000000),
       (4.15151899411611300000000000000), (4.14463042095659800000000000000),
       (4.38264830899989800000000000000), (4.50706679909951700000000000000),
       (4.58836815706024800000000000000), (4.65879094592402100000000000000),
       (4.68748392499113900000000000000), (4.88494352772807000000000000000),
       (4.96834632488414900000000000000)});
  double params[5] = {(1.0), (1.0), (1.0), (1.0), (1.0)};
  w.plot_scatter(data_x, data_y);
  for (auto i = 0; (i) < (n); (i) += (1)) {
    problem.AddResidualBlock(
        new AutoDiffCostFunction<ExponentialResidual, 1, 5>(
            new ExponentialResidual(data_x[i], data_y[i])),
        nullptr, params);
  }
  auto options = Solver::Options();
  auto summary = Solver::Summary();
  options.minimizer_progress_to_stdout = true;
  options.max_num_iterations = 100;
  options.linear_solver_type = ceres::DENSE_QR;
  Solve(options, &problem, &summary);
  {

    (std::cout) << (std::setw(10))
                << (std::chrono::high_resolution_clock::now()
                        .time_since_epoch()
                        .count())
                << (" ") << (std::this_thread::get_id()) << (" ") << (__FILE__)
                << (":") << (__LINE__) << (" ") << (__func__) << (" ") << ("")
                << (" ") << (std::setw(8)) << (" summary.BriefReport()='")
                << (summary.BriefReport()) << ("'") << (std::endl)
                << (std::flush);
  }
  for (auto i = 0; (i) < (5); (i) += (1)) {
    {

      (std::cout) << (std::setw(10))
                  << (std::chrono::high_resolution_clock::now()
                          .time_since_epoch()
                          .count())
                  << (" ") << (std::this_thread::get_id()) << (" ")
                  << (__FILE__) << (":") << (__LINE__) << (" ") << (__func__)
                  << (" ") << ("") << (" ") << (std::setw(8))
                  << (" params[i]='") << (params[i]) << ("'") << (std::endl)
                  << (std::flush);
    }
  }
  auto fit_n = 120;
  auto fit_x = std::vector<double>();
  auto fit_y = std::vector<double>();
  for (auto i = 0; (i) < (fit_n); (i) += (1)) {
    auto mi = (0.);
    auto ma = (5.0);
    auto x_ = ((((ma) * (i))) / (((fit_n) - (1))));
    auto N = 5;
    auto xrel = ((((x_) - (mi))) / (((ma) - (mi))));
    auto xpos = ((xrel) * (((N) - (2))));
    auto lo_idx = int(xpos);
    auto tau = ((xpos) - (lo_idx));
    auto hi_idx = ((1) + (lo_idx));
    assert((hi_idx) <= (4));
    assert((lo_idx) <= (3));
    assert((0) <= (hi_idx));
    assert((0) <= (lo_idx));
    auto lo_val = params[lo_idx];
    auto hi_val = params[hi_idx];
    auto lerp = ((((tau) * (lo_val))) +
                 ((((((1.0)) - (tau))) * (((hi_val) - (lo_val))))));
    fit_x.push_back(x_);
    fit_y.push_back(lerp);
  }
  w.plot_line(fit_x, fit_y);
  w.show();
  return app.exec();
}